version: "3.9"

services:
  frontend-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_NAME: frontend-server
    container_name: sentiment-analyzer-frontend
    ports: ["80:8080"]
    environment: 
      PORT: 8080
      ANALYZER_URL: http://data-analyzer:8080
      COLLECTOR_URL: http://data-collector:8080   
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  data-analyzer:
    build:
      args:
        APP_NAME: data-analyzer-server
    container_name: sentiment-analyzer
    ports: ["8881:8080"]
    environment:  
      PORT: 8080
      SELF_URL: http://data-analyzer:8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  data-collector:
    build:
      args:
        APP_NAME: data-collector-server
    container_name: sentiment-data-collector
    ports: ["8882:8080"]
    environment: 
      PORT: 8080
      ANALYZER_URL: http://data-analyzer:8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s      

  mongodb:
    image: mongo:7.0
    container_name: mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: sentiment_db
    ports:
      - "27017:27017"
    volumes:
      -  ./components/database/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    command: --quiet

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"    # AMQP port
      - "15672:15672"  # Management UI â†’ http://localhost:15672 
    environment:
      RABBITMQ_DEFAULT_USER: root
      RABBITMQ_DEFAULT_PASS: password
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 10